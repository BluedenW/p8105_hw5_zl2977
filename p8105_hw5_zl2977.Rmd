---
title: "p8105_hw5_zl2977"
author: "Zhourong Li zl2977"
date: "2020/11/16"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

# knitr::opts_chunk$set(
#   fig.width = 6,
#   fig.asp = .6,
#   out.width = "90%"
# )

knitr::opts_chunk$set(
 echo = TRUE,
 fig.width = 8,
 fig.height = 6,
 fig.asp = 0.618,
 out.width = "90%")

theme_set(theme_minimal() +
          theme(legend.position = "bottom",
                legend.title = element_blank(),
                plot.title = element_text(hjust = 0.5, size = 15),
                plot.subtitle = element_text(hjust = 0.5, size = 12)))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")

homicide_df
```




Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )

aggregate_df
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)

results_df
```


```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time.

```{r}
study_df=
  tibble(
    file_names = list.files("data/p2-data/"),
    file_paths = str_c("data/p2-data/", file_names)
    )%>%
  mutate(
    data = map(file_paths, read_csv)
    )%>% #now unnest and tidy the result
  unnest(data)%>%
  separate(
    file_names, into = c("arm", "subj_id"), sep = "_"
    )%>%
  mutate(
    subj_id = str_remove(subj_id, ".csv")
    )%>%
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observations",
    names_prefix = "week_"
    )%>%
  mutate(
    week = as.numeric(week)
         )%>%
  select(arm, subj_id, week, observations)
  
study_df %>%
  head(10) %>% #show first 10 rows of the table
  knitr::kable()

study_df
```
   
Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.

```{r}

study_df%>%
  ggplot(aes(x = week, y = observations, group = subj_id, color = subj_id))+
  geom_line(size = .8, alpha = .7) + 
  geom_point(size = 1.5, alpha = .6, aes(shape = arm)) +
  facet_grid(~arm) +
  labs(title = "Spaghetti Plot",
       subtitle = "Showing Observations on each subject over time", 
       x = "week",
       y = "observations")

    
```
From the spaghetti plot above, we can see both arms have approximate observation values at beginning, the observation values in the control group do not change much over time, while the observation values in the experimental group increase over time.

## Problem 3

```{r}
set.seed(50)

sim_test=function(n=30, mean=0, sd=5){
  if (!is.numeric(mean)) {
    stop("Argument mean should be numeric")}
  sim_data =tibble(
    rnorm(n, mean, sd)
  )
  test_result = t.test(sim_data , conf.level = 0.95)
  sim_data %>%
    summarize(
    mu_hat =pull(broom::tidy(test_result),estimate),
    p_val = pull(broom::tidy(test_result),p.value)
    )
} 

sim_test()
```

```{r}
sim_results=
  tibble(mean_df=c(0,1,2,3,4,5,6))%>% # first mu=0, then repeat for mu=1,2,3,4,5,6
  mutate(
    output_lists = map(.x=mean_df,~rerun(5000,sim_test(mean=.x))),
    estimate_dfs = map(output_lists, bind_rows)
  )%>%
  select(-output_lists) %>%
  unnest(estimate_dfs)
sim_results 
```

Make a plot showing the proportion of times the null was rejected (the power of the test) on the y axis and the true value of Î¼ on the x axis. 

```{r}
sim_results %>%
  group_by(mean_df) %>%
  mutate(
    true_mean = as.factor(mean_df)
  )
```


