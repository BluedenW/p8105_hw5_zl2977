---
title: "p8105_hw5_zl2977"
author: "Zhourong Li zl2977"
date: "2020/11/16"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

# knitr::opts_chunk$set(
#   fig.width = 6,
#   fig.asp = .6,
#   out.width = "90%"
# )

knitr::opts_chunk$set(
 echo = TRUE,
 fig.width = 8,
 fig.height = 6,
 fig.asp = 0.618,
 out.width = "90%")

theme_set(theme_minimal() +
          theme(legend.position = "bottom",
                legend.title = element_blank(),
                plot.title = element_text(hjust = 0.5, size = 15),
                plot.subtitle = element_text(hjust = 0.5, size = 12)))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")

homicide_df
```




Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )

aggregate_df
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)

results_df
```


```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time.

```{r}
study_df=
  tibble(
    file_names = list.files("data/p2-data/"),
    file_paths = str_c("data/p2-data/", file_names)
    )%>%
  mutate(
    data = map(file_paths, read_csv)
    )%>% #now unnest and tidy the result
  unnest(data)%>%
  separate(
    file_names, into = c("arm", "subj_id"), sep = "_"
    )%>%
  mutate(
    subj_id = str_remove(subj_id, ".csv")
    )%>%
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "observations",
    names_prefix = "week_"
    )%>%
  mutate(
    week = as.numeric(week)
         )%>%
  select(arm, subj_id, week, observations)
  
study_df %>%
  head(10) %>% #show first 10 rows of the table
  knitr::kable()

study_df
```
   
Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.

```{r}

study_df%>%
  ggplot(aes(x = week, y = observations, group = subj_id, color = subj_id))+
  geom_line(size = .8, alpha = .7) + 
  geom_point(size = 1.5, alpha = .6, aes(shape = arm)) +
  facet_grid(~arm) +
  labs(title = "Spaghetti Plot",
       subtitle = "Showing Observations on each subject over time", 
       x = "week",
       y = "observations")

    
```
From the spaghetti plot above, we can see both arms have approximate observation values at beginning, the observation values in the control group do not change much over time, while the observation values in the experimental group increase over time.

## Problem 3

```{r}
  # sim_test=function(n=30, mean=0, sd=5){
  #  sim_data = tibble(
  #   x = rnorm(n, mean = mu, sd = sigma)
  # ) 
  # }  
  sim_test=function(n=30, mean=0, sd=5){
   sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
  ) 
  }  

  # sim_test()
  tests_data = t.test(sim_data, conf.level = 0.95)
  
  tests_data
```

```{r}
  mu_hat =pull(broom::tidy(tests_data),estimate)

#   tests_data
# mu_hat


output=rerun(50,sim_test)
   
      
output[1]      
    
# tests_data = t.test(output[1], conf.level = 0.95)
# mu_hats_list=map(.x=rerun(50,sim_test), ~t.test(.x, conf.level = 0.95))
# mu_hats_list
```

```{r}
library("dplyr")                             
  
# Create three data frames 
data1 <- data.frame(x1 = 1:5,                
                    x2 = 1:5) 
data1

data2 <- data.frame(x1 = 0, 
                    x2 = 5:9) 
data2

data3 <- data.frame(x3 = 5:9, 
                    x4 = letters[5:9]) 
data3

# Apply bind_cols function 
bind_rows(data1, data2, id = NULL)    
```


